@using Web_Join.Views.Home
@model Web_Join.Models.ViewModels.AdminViewModel
@{
    ViewData["Title"] = "Admin";
}

<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

@if (!Model.IsAdmin)
{
    <div class="container py-5" style="max-width:500px;">
        <h2 class="mb-4">Admin Login</h2>
        @if (Model.LoginError != null)
        {
            <div class="alert alert-danger py-2">@Model.LoginError</div>
        }
        <form method="post" asp-page-handler="Login" class="card p-4 shadow-sm">
            <div class="mb-3">
                <label class="form-label">Benutzername</label>
                <input asp-for="AdminUser" class="form-control" required />
            </div>
            <div class="mb-3">
                <label class="form-label">Passwort</label>
                <input asp-for="AdminPassword" type="password" class="form-control" required />
            </div>
            <div class="d-flex justify-content-between align-items-center">
                <button class="btn btn-primary">Login</button>
                <small class="text-muted">Demo: Admin / 0000</small>
            </div>
        </form>
        <div class="mt-3">
            <a asp-action="Index" asp-controller="Home" class="btn btn-link">&laquo; Zurück</a>
        </div>
    </div>
}
else
{
    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <h2 class="mb-0">Tickets Verwaltung</h2>
            <div class="d-flex gap-2">
                <form method="get" asp-action="Admin" asp-controller="Home" class="d-flex align-items-center gap-2">
                    <input type="hidden" name="showOnlyOpen" value="@(!Model.ShowOnlyOpen)" />
                    <button class="btn btn-outline-secondary">
                        @if (Model.ShowOnlyOpen) { <text>Alle anzeigen</text> } else { <text>Nur offene</text> }
                    </button>
                </form>
                <form method="post" asp-page-handler="Logout">
                    <button class="btn btn-outline-danger">Logout</button>
                </form>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalStammdaten">Neu (Stammdaten)</button>
                <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#newTicketForm">Neues Ticket</button>
            </div>
        </div>

        <div class="collapse mb-4" id="newTicketForm">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="mb-3">Neues Ticket</h5>
                    <form method="post" asp-page-handler="CreateTicket">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">User</label>
                                <select asp-for="NewTicketUserID" class="form-select" required>
                                    <option value="">-- wählen --</option>
                                    @foreach (var u in Model.Users)
                                    {
                                        <option value="@u.UID">@u.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Status</label>
                                <select asp-for="NewTicketStatusID" class="form-select" required>
                                    <option value="">-- wählen --</option>
                                    @foreach (var s in Model.Statuses)
                                    {
                                        <option value="@s.SID">@s.Title</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Priorität</label>
                                <select asp-for="NewTicketPriorityID" class="form-select" required>
                                    <option value="">-- wählen --</option>
                                    @foreach (var p in Model.Priorities)
                                    {
                                        <option value="@p.PID">@p.Title</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Kategorie</label>
                                <select asp-for="NewTicketCategoryID" class="form-select" required>
                                    <option value="">-- wählen --</option>
                                    @foreach (var c in Model.Categories)
                                    {
                                        <option value="@c.CID">@c.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Titel</label>
                                <input asp-for="NewTicketTitle" class="form-control" maxlength="200" required />
                                <span class="text-danger small" asp-validation-for="NewTicketTitle"></span>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Beschreibung</label>
                                <textarea asp-for="NewTicketDescription" class="form-control" rows="3"></textarea>
                            </div>
                            <div class="col-12 d-flex gap-2">
                                <button class="btn btn-primary">Speichern</button>
                                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#newTicketForm">Abbruch</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="table-responsive card shadow-sm">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Titel</th>
                        <th>Status</th>
                        <th>Priorität</th>
                        <th>Kategorie</th>
                        <th>User</th>
                        <th>Erstellt</th>
                        <th>Beschreibung</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var t in Model.Tickets)
                    {
                        var prioClass = t.Priority?.Title switch
                        {
                            "Hoch" => "badge bg-danger",
                            "Kritisch" => "badge bg-danger",
                            "Dringend" => "badge bg-warning text-dark",
                            _ => "badge bg-secondary"
                        };
                        <tr>
                            <td class="text-muted">@t.TID</td>
                            <td>@t.Title</td>
                            <td><span class="badge bg-info">@t.Status?.Title</span></td>
                            <td><span class="@prioClass">@t.Priority?.Title</span></td>
                            <td>@t.Category?.Name</td>
                            <td>@t.User?.Name</td>
                            <td>@t.Createdate.ToString("dd.MM.yyyy HH:mm")</td>
                            <td class="small text-truncate" style="max-width:280px;">@t.Description</td>
                        </tr>
                    }
                    @if (!Model.Tickets.Any())
                    {
                        <tr>
                            <td colspan="8" class="text-center text-muted py-4">Keine Tickets vorhanden.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="mt-3">
            <a asp-page="/Index" class="btn btn-link">&laquo; Zurück zur Startseite</a>
        </div>
    </div>

    <!-- Modal Stammdaten -->
    <div class="modal fade" id="modalStammdaten" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Stammdaten anlegen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Typ auswählen</label>
                        <select id="entitySelect" class="form-select" onchange="showEntityForm()">
                            <option value="">-- wählen --</option>
                            <option value="category">Kategorie</option>
                            <option value="status">Status</option>
                            <option value="priority">Priorität</option>
                        </select>
                    </div>

                    <form id="form-category" class="d-none" method="post" asp-page-handler="CreateCategory">
                        <h6>Kategorie</h6>
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input asp-for="CreateCategoryName" class="form-control" maxlength="100" required />
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success">Anlegen</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForms()">Abbruch</button>
                        </div>
                    </form>

                    <form id="form-status" class="d-none" method="post" asp-page-handler="CreateStatus">
                        <h6>Status</h6>
                        <div class="mb-3">
                            <label class="form-label">Titel</label>
                            <input asp-for="CreateStatusTitle" class="form-control" maxlength="100" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Beschreibung</label>
                            <textarea asp-for="CreateStatusDescription" class="form-control" maxlength="200" rows="3" required></textarea>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success">Anlegen</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForms()">Abbruch</button>
                        </div>
                    </form>

                    <form id="form-priority" class="d-none" method="post" asp-page-handler="CreatePriority">
                        <h6>Priorität</h6>
                        <div class="mb-3">
                            <label class="form-label">Titel</label>
                            <input asp-for="CreatePriorityTitle" class="form-control" maxlength="100" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Beschreibung</label>
                            <textarea asp-for="CreatePriorityDescription" class="form-control" maxlength="200" rows="3" required></textarea>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success">Anlegen</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetForms()">Abbruch</button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Schließen</button>
                </div>
            </div>
        </div>
    </div>
    }

@section Scripts{
    <partial name="_ValidationScriptsPartial" />
    <script>
        function showEntityForm() {
            const value = document.getElementById('entitySelect').value;
            ['category','status','priority'].forEach(v => {
                document.getElementById('form-' + v).classList.toggle('d-none', v !== value);
            });
        }
        function resetForms() {
            document.getElementById('entitySelect').value = '';
            showEntityForm();
        }
    </script>
}